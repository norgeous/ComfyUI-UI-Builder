name: ‚ûï PR

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed

concurrency: preview-${{ github.ref }}

jobs:
  ci:
    name: ü¶æ CI
    uses: ./.github/workflows/ci.yml
    with:
      ref: ${{ github.head_ref || github.ref_name }}

  deploy-preview:
    name: ‚úçÔ∏è Commit to "gh-pages"
    needs: [ci]
    if: ${{ always() && !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      - name: ‚ôªÔ∏è Restore gh-pages
        id: gh_pages_cache
        uses: actions/cache@v4
        with:
          path: gh-pages-directory
          key: gh-pages-${{ needs.ci.outputs.KEY_BRANCH }}

      - name: ‚§µÔ∏è Checkout "${{ github.head_ref || github.ref_name }}" branch
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: ‚ôªÔ∏è Restore storybook-static
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: packages/storybook/storybook-static
          key: storybook-static-${{ needs.ci.outputs.KEY_BRANCH }}
          # fail-on-cache-miss: true

      - name: ‚ôªÔ∏è Restore visdiff-report
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: packages/storybook/visdiff-report
          key: visdiff-report-${{ needs.ci.outputs.KEY_BRANCH }}
          # fail-on-cache-miss: true

      - name: ‚ôªÔ∏è Restore storybook-test
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: storybook-test-report.txt
          key: storybook-test-${{ needs.ci.outputs.KEY_BRANCH }}
          # fail-on-cache-miss: true

      - name: ‚ôªÔ∏è Restore storycaps
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        id: storycaps_cache
        uses: actions/cache@v4
        with:
          path: _storycaps_
          key: storycaps-${{ needs.ci.outputs.KEY_BRANCH }}

      - name: üìÑ Create storycaps/index.html
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        run: |
          find _storycaps_ -type f -printf "%P\n" | sort | sed -e 's/ /%20/g' -e 's/^/<img src="/g' -e 's/$/" \/>/g' > _storycaps_/index.html

      - name: üéº Compose artifact
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        run: |
          mkdir gh-pages-directory
          mv packages/storybook/visdiff-report/ gh-pages-directory/visdiff-report/
          mv packages/storybook/storybook-static/ gh-pages-directory/storybook/
          mv storybook-test-report.txt gh-pages-directory/
          mv _storycaps_ gh-pages-directory/storycaps/
          echo "<center>" | tee -a gh-pages-directory/index.html
          echo "<h1>${{ github.head_ref || github.ref_name }}</h1>" | tee -a gh-pages-directory/index.html
          echo "<h2><a href="storybook">üìï Storybook</a></h2>" | tee -a gh-pages-directory/index.html
          echo "<h2><a href="storybook-test-report.txt">üß™ Storybook test report</a></h2>" | tee -a gh-pages-directory/index.html
          echo "<h2><a href="visdiff-report">üé≠ Visdiff report</a></h2>" | tee -a gh-pages-directory/index.html
          echo "<h2><a href="storycaps">üß¢ Storycaps</a></h2>" | tee -a gh-pages-directory/index.html
          echo "<h2>${{ needs.ci.outputs.KEY_BRANCH }}</h2>" | tee -a gh-pages-directory/index.html
          echo "<h2>$(date +'%d-%m-%Y %H:%M:%S')</h2>" | tee -a gh-pages-directory/index.html
          echo "</center>" | tee -a gh-pages-directory/index.html

      - name: ‚úçÔ∏è Commit to "gh-pages" branch
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: rossjrw/pr-preview-action@v1
        with:
          source-dir: gh-pages-directory
