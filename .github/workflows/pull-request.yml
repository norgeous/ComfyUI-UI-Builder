name: pages-build

on:
  push:
    branches:
      - develop
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed

concurrency: preview-${{ github.ref }}

jobs:
  ci:
    name: ü¶æ CI
    uses: ./.github/workflows/ci.yml
    with:
      ref: ${{ github.head_ref || github.ref_name }}

  deploy-preview:
    name: ‚úçÔ∏è Commit to "gh-pages"
    needs: [ci]
    if: ${{ always() && !cancelled() }}
    runs-on: ubuntu-latest
    steps:
      - name: ‚ôªÔ∏è Restore gh-pages
        id: gh_pages_cache
        uses: actions/cache@v4
        with:
          path: gh-pages-directory
          key: ${{ needs.ci.outputs.CACHE_KEY_GH_PAGES }}

      - name: ‚§µÔ∏è Checkout "${{ github.head_ref || github.ref_name }}" branch
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: ‚ôªÔ∏è Restore node_modules
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: |
            npm-install-report
            node_modules
            packages/storybook/node_modules
          key: ${{ needs.ci.outputs.CACHE_KEY_NPM_INSTALL }}

      - name: ‚ôªÔ∏è Restore lint-report
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: lint-report
          key: ${{ needs.ci.outputs.CACHE_KEY_LINT }}
          fail-on-cache-miss: true

      - name: ‚ôªÔ∏è Restore Vite dist
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/cache/restore@v4
        with:
          path: dist
          key: ${{ needs.ci.outputs.CACHE_KEY_VITE_DIST }}
          fail-on-cache-miss: true

      - name: ‚ôªÔ∏è Restore storybook-static
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/cache/restore@v4
        with:
          path: packages/storybook/storybook-static
          key: ${{ needs.ci.outputs.CACHE_KEY_STORYBOOK }}
          fail-on-cache-miss: true

      - name: ‚ôªÔ∏è Restore storybook-test
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/cache/restore@v4
        with:
          path: storybook-test
          key: ${{ needs.ci.outputs.CACHE_KEY_SB_TEST }}
          fail-on-cache-miss: true

      - name: ‚ôªÔ∏è Restore storycaps
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/cache/restore@v4
        with:
          path: _storycaps_
          key: ${{ needs.ci.outputs.CACHE_KEY_STORYCAPS }}
          fail-on-cache-miss: true

      - name: ‚ôªÔ∏è Restore visdiff-report
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/cache/restore@v4
        with:
          path: packages/storybook/visdiff-report
          key: ${{ needs.ci.outputs.CACHE_KEY_VISDIFF }}
          fail-on-cache-miss: true

      - name: üìÑ Create storycaps index.html
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        run: |
          find _storycaps_ -type f -printf "%P\n" | sort | sed -e 's/ /%20/g' -e 's/^/<img src="/g' -e 's/$/" \/>/g' > _storycaps_/index.html

      - name: üìÑ Create ghindex.html
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        run: |
          echo "<style>body{font-family:Arial;background:black;color:white} a{color:white;text-decoration:none}</style>" | tee -a ghindex.html
          echo "<center>" | tee -a ghindex.html
          echo "<h1>Summary for: ${{ github.head_ref || github.ref_name }}</h1>" | tee -a ghindex.html
          echo "<table>" | tee -a ghindex.html

          ((`cat npm-install-report/EXITCODE` == 0)) && NPMINSTALLEMOJI='‚úÖ' || NPMINSTALLEMOJI='‚ùå'
          echo "<tr><td><a href="npm-install-report/summary.txt">üß∞ NPM Install</a></td><td>$NPMINSTALLEMOJI</td></tr>" | tee -a ghindex.html

          ((`cat lint-report/EXITCODE` == 0)) && LINTEMOJI='‚úÖ' || LINTEMOJI='‚ùå'
          echo "<tr><td><a href="lint-report/summary.txt">üßµ Lint</a></td><td>$LINTEMOJI</td></tr>" | tee -a ghindex.html

          ((`cat vite/EXITCODE` == 0)) && VITEEMOJI='‚úÖ' || VITEEMOJI='‚ùå'
          echo "<tr><td><a href="vite/summary.txt">üáª Vite</a></td><td>$VITEEMOJI</td></tr>" | tee -a ghindex.html

          ((`cat packages/storybook/storybook-static/EXITCODE` == 0)) && STORYBOOKEMOJI='‚úÖ' || STORYBOOKEMOJI='‚ùå'
          echo "<tr><td><a href="storybook">üìï Storybook</a></td><td>$STORYBOOKEMOJI</td></tr>" | tee -a ghindex.html

          ((`cat storybook-test/EXITCODE` == 0)) && SBTESTEMOJI='‚úÖ' || SBTESTEMOJI='‚ùå'
          echo "<tr><td><a href="storybook-test/summary.txt">üß™ Storybook Test</a></td><td>$SBTESTEMOJI</td></tr>" | tee -a ghindex.html

          ((`cat _storycaps_/EXITCODE` == 0)) && STORYCAPEMOJI='‚úÖ' || STORYCAPEMOJI='‚ùå'
          echo "<tr><td><a href="storycaps">üß¢ Storycap</a></td><td>$STORYCAPEMOJI</td></tr>" | tee -a ghindex.html

          ((`cat packages/storybook/visdiff-report/EXITCODE` == 0)) && VISDIFFEMOJI='‚úÖ' || VISDIFFEMOJI='‚ùå'
          echo "<tr><td><a href="visdiff-report">üé≠ Visdiff</a></td><td>$VISDIFFEMOJI</td></tr>" | tee -a ghindex.html

          echo "</table>" | tee -a ghindex.html
          echo "<h6>built at: $(date +'%d-%m-%Y %H:%M:%S %Z')</h6>" | tee -a ghindex.html
          echo "</center>" | tee -a ghindex.html

      - name: üéº Compose Artifact
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        run: |
          mkdir gh-pages-directory
          mv npm-install-report/                  gh-pages-directory/npm-install-report/
          mv lint-report/                         gh-pages-directory/lint-report/
          mv packages/storybook/visdiff-report/   gh-pages-directory/visdiff-report/
          mv packages/storybook/storybook-static/ gh-pages-directory/storybook/
          mv storybook-test/                      gh-pages-directory/storybook-test/
          mv _storycaps_/                         gh-pages-directory/storycaps/
          mv ghindex.html                         gh-pages-directory/index.html

      - name: ‚úçÔ∏è Push PR preview to "gh-pages" branch
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: rossjrw/pr-preview-action@v1
        with:
          source-dir: gh-pages-directory

      - name: ‚úçÔ∏è Commit develop to "gh-pages" branch
        if: steps.gh_pages_cache.outputs.cache-hit != 'true' && github.ref_name == 'develop'
        run: |
          git checkout origin/gh-pages
          git config user.name github-actions
          git config user.email github-actions@github.com
          mv gh-pages-directory develop
          git add develop | tee -a $GITHUB_STEP_SUMMARY
          git commit -m "üöÄ Deploy develop" | tee -a $GITHUB_STEP_SUMMARY
          git push
