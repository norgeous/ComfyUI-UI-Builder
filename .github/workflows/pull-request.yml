name: âž• PR

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed

concurrency: preview-${{ github.ref }}

jobs:
  ci:
    name: ðŸ¦¾ CI
    uses: ./.github/workflows/ci.yml
    with:
      ref: ${{ github.head_ref || github.ref_name }}

  deploy-preview:
    name: ðŸš€ Deploy preview
    needs: [ci]
    runs-on: ubuntu-latest
    steps:
      - name: â™»ï¸ Restore gh-pages
        id: gh_pages_cache
        uses: actions/cache@v4
        with:
          path: gh-pages-directory
          key: gh-pages-${{ needs.ci.outputs.KEY_BRANCH }}

      - name: â¤µï¸ Checkout "${{ github.head_ref || github.ref_name }}" branch
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: â™»ï¸ Restore storybook-static
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: packages/storybook/storybook-static
          key: storybook-static-${{ needs.ci.outputs.KEY_BRANCH }}
          fail-on-cache-miss: true

      - name: â™»ï¸ Restore visdiff-report
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: packages/storybook/visdiff-report
          key: visdiff-report-${{ needs.ci.outputs.KEY_BRANCH }}
          fail-on-cache-miss: true

      - name: â™»ï¸ Restore storybook-test
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: storybook-test-report.txt
          key: storybook-test-${{ needs.ci.outputs.KEY_BRANCH }}
          fail-on-cache-miss: true

      - name: â™»ï¸ Restore storycaps
        id: storycaps_cache
        uses: actions/cache@v4
        with:
          path: _storycaps_
          key: storycaps-${{ needs.ci.outputs.KEY_BRANCH }}

      - name: âœï¸ Create storycaps index.md
        if: steps.storycaps_cache.outputs.cache-hit != 'true'
        run: |
          find _storycaps_ -type f -printf '![storycap](https://raw.githubusercontent.com/norgeous/ComfyUI-UI-Builder/storycaps/%p)\n' | sort | sed 's/ /%20/g' > _storycaps_/index.md

      - name: ðŸŽ¼ Compose artifact
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        run: |
          mkdir gh-pages-directory
          mv packages/storybook/visdiff-report/ gh-pages-directory/visdiff-report/
          mv packages/storybook/storybook-static/ gh-pages-directory/storybook/
          mv storybook-test-report.txt gh-pages-directory/
          mv _storycaps_ gh-pages-directory/storycaps/
          echo "<center>" | tee -a gh-pages-directory/index.html
          echo "<h1><a href="storybook">ðŸ“• Storybook</a></h1>" | tee -a gh-pages-directory/index.html
          echo "<h1><a href="storybook-test-report.txt">ðŸ§ª Storybook test report</a></h1>" | tee -a gh-pages-directory/index.html
          echo "<h1><a href="visdiff-report">ðŸŽ­ Visdiff report</a></h1>" | tee -a gh-pages-directory/index.html
          echo "<h1><a href="storycaps">ðŸ§¢ Storycaps</a></h1>" | tee -a gh-pages-directory/index.html
          echo "<h1>${{ needs.ci.outputs.KEY_BRANCH }}</h1>" | tee -a gh-pages-directory/index.html
          echo "<h1>$(date +'%d-%m-%Y %H:%M:%S')</h1>" | tee -a gh-pages-directory/index.html
          echo "</center>" | tee -a gh-pages-directory/index.html

      - name: ðŸš€ Deploy preview to "gh-pages" branch
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: rossjrw/pr-preview-action@v1
        with:
          source-dir: gh-pages-directory
