name: ‚ûï PR

on:
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed

concurrency: preview-${{ github.ref }}

jobs:
  ci:
    name: ü¶æ CI
    uses: ./.github/workflows/ci.yml
    with:
      ref: ${{ github.head_ref || github.ref_name }}

  deploy-preview:
    name: üöÄ Deploy preview
    needs: [ci]
    runs-on: ubuntu-latest
    steps:
      - name: ‚ôªÔ∏è Restore gh-pages
        id: gh_pages_cache
        uses: actions/cache@v4
        with:
          path: gh-pages-directory
          key: gh-pages-${{ needs.ci.outputs.KEY_BRANCH }}

      - name: ‚§µÔ∏è Checkout "${{ github.head_ref || github.ref_name }}" branch
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: ‚ôªÔ∏è Restore storybook-static
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: packages/storybook/storybook-static
          key: storybook-static-${{ needs.ci.outputs.KEY_BRANCH }}
          fail-on-cache-miss: true

      - name: ‚ôªÔ∏è Restore visdiff-report
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: packages/storybook/visdiff-report
          key: visdiff-report-${{ needs.ci.outputs.KEY_BRANCH }}
          fail-on-cache-miss: true

      - name: ‚ôªÔ∏è Restore storybook-test
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: storybook-test-report.txt
          key: storybook-test-${{ needs.ci.outputs.KEY_BRANCH }}
          fail-on-cache-miss: true

      - name: üéº Compose artifact
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        run: |
          mkdir gh-pages-directory
          mv packages/storybook/visdiff-report/ gh-pages-directory/visdiff-report/
          mv packages/storybook/storybook-static/ gh-pages-directory/storybook/
          mv storybook-test-report.txt gh-pages-directory/
          echo "<center>" | tee -a gh-pages-directory/index.html
          echo "<h1><a href="storybook">üìï Storybook</a></h1>" | tee -a gh-pages-directory/index.html
          echo "<h1><a href="storybook-test-report.txt">üß™ Storybook test report</a></h1>" | tee -a gh-pages-directory/index.html
          echo "<h1><a href="visdiff-report">üé≠ Visdiff report</a></h1>" | tee -a gh-pages-directory/index.html
          echo "<h1>${{ needs.ci.outputs.KEY_BRANCH }}</h1>" | tee -a gh-pages-directory/index.html
          echo "<h1>$(date +'%d-%m-%Y %H:%M:%S')</h1>" | tee -a gh-pages-directory/index.html
          echo "</center>" | tee -a gh-pages-directory/index.html

      - name: üöÄ Deploy preview to "gh-pages" branch
        if: steps.gh_pages_cache.outputs.cache-hit != 'true'
        uses: rossjrw/pr-preview-action@v1
        with:
          source-dir: gh-pages-directory
