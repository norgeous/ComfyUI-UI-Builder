name: pages-build

on:
  push:
    branches:
      - develop
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed

concurrency: preview-${{ github.ref }}

jobs:
  ci:
    name: ğŸ¦¾ CI
    uses: ./.github/workflows/ci.yml
    with:
      ref: ${{ github.head_ref || github.ref_name }}

  deploy-preview:
    name: ğŸš€ Deploy preview to "gh-pages"
    needs: [ci]
    if: ${{ always() && !cancelled() && github.ref_name != 'develop' }}
    runs-on: ubuntu-latest
    steps:
      - name: â¤µï¸ Checkout "${{ github.head_ref || github.ref_name }}" branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: â™»ï¸ Restore gh-pages
        id: gh_pages_cache
        uses: actions/cache@v4
        with:
          path: gh-pages-directory
          key: ${{ needs.ci.outputs.CACHE_KEY_GH_PAGES }}
          fail-on-cache-miss: true

      - name: âœï¸ Commit build to "gh-pages" branch
        uses: rossjrw/pr-preview-action@v1
        with:
          source-dir: gh-pages-directory

  deploy-develop:
    name: ğŸš€ Deploy develop to "gh-pages"
    needs: [ci]
    if: ${{ always() && !cancelled() && github.ref_name == 'develop' }}
    runs-on: ubuntu-latest
    steps:
      - name: â¤µï¸ Checkout "gh-pages" branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: â™»ï¸ Restore gh-pages
        id: gh_pages_cache
        uses: actions/cache@v4
        with:
          path: gh-pages-directory
          key: ${{ needs.ci.outputs.CACHE_KEY_GH_PAGES }}
          fail-on-cache-miss: true

      - name: âœï¸ Commit build to "gh-pages" branch
        run: |
          rm -rf develop
          git config user.name github-actions
          git config user.email github-actions@github.com
          mv gh-pages-directory develop
          git add develop | tee -a $GITHUB_STEP_SUMMARY
          git commit -m "ğŸš€ Deploy develop" | tee -a $GITHUB_STEP_SUMMARY
          git push | tee -a $GITHUB_STEP_SUMMARY

  release:
    name: ğŸš€ Release
    needs: [ci]
    if: ${{ !cancelled() && github.ref_name == 'develop' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: â¤µï¸ Checkout "develop" branch
        uses: actions/checkout@v4
        with:
          ref: release

      - name: â™»ï¸ Restore dist
        uses: actions/cache@v4
        with:
          path: dist
          key: ${{ needs.ci.outputs.CACHE_KEY_VITE_DIST }}
          fail-on-cache-miss: true

      - name: â¤µï¸ Checkout __init__.py from develop
        uses: actions/checkout@v4
        with:
          ref: develop
          sparse-checkout: __init__.py
          sparse-checkout-cone-mode: false

      - name: âœï¸ Commit to "release" branch
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com
          git commit -am "ğŸš€ Release from develop" | tee -a $GITHUB_STEP_SUMMARY
          # git push | tee -a $GITHUB_STEP_SUMMARY

      # - name: ğŸ“‹ğŸ˜  Prepare orphan "release" branch
      #   run: |
      #     git checkout --orphan release
      #     git rm --cached -rf .
      #     rm README.md
      #     mv README.release.md README.md
      #     echo -e 'node_modules\n__pycache__\n' > .gitignore

      # - name: ğŸ‘¤ Setup git user
      #   run: |
      #     git config user.name github-actions
      #     git config user.email github-actions@github.com

      # - name: âœï¸ Commit to "release" branch
      #   run: |
      #     git add dist/
      #     git add README.md
      #     git add .gitignore
      #     git add __init__.py
      #     git commit -m "ğŸ‡» Vite Build"

      # - name: ğŸ«¸ Force push "release" branch to origin
      #   run: |
      #     git push origin release --force # TODO: dont force
