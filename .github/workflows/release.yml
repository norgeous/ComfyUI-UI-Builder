name: 🚀 Release
on:
  push:
    branches:
      - develop

jobs:
  ci:
    name: 🦾 CI
    uses: ./.github/workflows/ci.yml
    with:
      ref: 'develop'

  release:
    name: 🚀 Release to "release" branch
    needs: [ci]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ⤵️ Checkout "develop" branch
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: ♻️ Restore dist
        uses: actions/cache@v4
        with:
          path: dist
          key: ${{ needs.ci.outputs.CACHE_KEY_VITE_DIST }}

      - name: 📋 Prepare orphan "release" branch
        run: |
          git checkout --orphan release
          git rm --cached -rf .
          rm README.md
          mv README.release.md README.md
          echo -e 'node_modules\n__pycache__\n' > .gitignore

      - name: 👤 Setup git user
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

      - name: ✍️ Commit to "release" branch
        run: |
          git add dist/
          git add README.md
          git add .gitignore
          git add __init__.py
          git commit -m "🇻 Vite Build"

      - name: 🫸 Force push "release" branch to origin
        run: |
          git push origin release --force # TODO: dont force
