name: pages-build

on:
  push:
    branches:
      - develop
  pull_request:
    types:
      - opened
      - reopened
      - synchronize
      - closed

concurrency: preview-${{ github.ref }}

jobs:
  ci:
    name: ü¶æ CI
    uses: ./.github/workflows/ci.yml
    with:
      ref: ${{ github.head_ref || github.ref_name }}

  deploy-preview:
    name: üöÄ Deploy preview to "gh-pages"
    needs: [ci]
    if: ${{ always() && !cancelled() && github.ref_name != 'develop' }}
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Checkout "${{ github.head_ref || github.ref_name }}" branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref || github.ref_name }}

      - name: ‚ôªÔ∏è Restore gh-pages
        id: gh_pages_cache
        uses: actions/cache@v4
        with:
          path: gh-pages-directory
          key: ${{ needs.ci.outputs.CACHE_KEY_GH_PAGES }}
          fail-on-cache-miss: true

      - name: ‚úçÔ∏è Commit build to "gh-pages" branch
        uses: rossjrw/pr-preview-action@v1
        with:
          source-dir: gh-pages-directory

  deploy-develop:
    name: üöÄ Deploy develop to "gh-pages"
    needs: [ci]
    if: ${{ always() && !cancelled() && github.ref_name == 'develop' }}
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Checkout "gh-pages" branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      - name: ‚ôªÔ∏è Restore gh-pages
        id: gh_pages_cache
        uses: actions/cache@v4
        with:
          path: gh-pages-directory
          key: ${{ needs.ci.outputs.CACHE_KEY_GH_PAGES }}
          fail-on-cache-miss: true

      - name: ‚úçÔ∏è Commit build to "gh-pages" branch
        run: |
          rm -rf develop
          git config user.name github-actions
          git config user.email github-actions@github.com
          mv gh-pages-directory develop
          git add develop | tee -a $GITHUB_STEP_SUMMARY
          git commit -m "üöÄ Deploy develop" | tee -a $GITHUB_STEP_SUMMARY
          git push | tee -a $GITHUB_STEP_SUMMARY

  release:
    name: üöÄ Release
    needs: [ci]
    if: ${{ !cancelled() && github.ref_name == 'develop' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ‚§µÔ∏è Checkout "release" branch
        uses: actions/checkout@v4
        with:
          ref: release

      - name: ‚ôªÔ∏è Restore dist
        uses: actions/cache@v4
        with:
          path: dist
          key: ${{ needs.ci.outputs.CACHE_KEY_VITE_DIST }}
          fail-on-cache-miss: true

      - name: ‚§µÔ∏è Checkout __init__.py from develop
        uses: actions/checkout@v4
        with:
          ref: develop
          sparse-checkout: |
            __init__.py
            README.release.md
          sparse-checkout-cone-mode: false

      - name: ‚úçÔ∏è Commit to "release" branch
        run: |
          # rm README.md
          mv README.release.md README.md
          git status
          git checkout release
          git status
          git config user.name github-actions
          git config user.email github-actions@github.com
          git commit -am "üöÄ Release from develop" | tee -a $GITHUB_STEP_SUMMARY
          git status | tee -a $GITHUB_STEP_SUMMARY
          # git push | tee -a $GITHUB_STEP_SUMMARY
