name: ğŸ“• Storybook
on:
  push:
    branches:
      - develop

    # Trigger the action only when files change in the folders defined here
    paths:
      [
        '.github/workflows/storybook.yml',
        'packages/storybook/**',
        'public/**',
        'src/components/**',
      ]

jobs:
  storybook-static:
    runs-on: ubuntu-latest
    steps:
      - name: â¤µï¸ Checkout
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: ğŸ§° NPM Install
        run: |
          npm ci

      - name: ğŸ”¨ Storybook Build
        run: |
          npm run sb:build

      - name: ğŸ¦ Cache node_modules and storybook-static
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/storybook/storybook-static
          key: ${{ runner.os }}-${{ hashFiles('packages/storybook/storybook-static/**') }}

      - name: ğŸ†™ Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: storybook-static-artifact
          path: packages/storybook/storybook-static

  github-pages-deploy:
    needs: storybook-static
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    steps:
      - name: â¬‡ï¸ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: storybook-static-artifact
          path: packages/storybook/storybook-static

      - name: ğŸ†™ Upload pages artifact
        uses: actions/upload-pages-artifact@v3.0.1
        with:
          name: storybook-static-pages-artifact
          path: packages/storybook/storybook-static

      - name: ğŸš€ Deploy artifact to Github pages
        uses: actions/deploy-pages@v4
        with:
          artifact_name: storybook-static-pages-artifact

  storybook-test:
    needs: storybook-static
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    steps:
      - name: â¤µï¸ Checkout
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: â¬‡ï¸ Download artifact
        uses: actions/download-artifact@v4
        with:
          name: storybook-static-artifact
          path: packages/storybook/storybook-static

      - name: ğŸ§° NPM Install
        run: |
          npm ci

      - name: â–¶ï¸ Playwright Install
        run: |
          npx playwright install chromium

      - name: ğŸ§ª Storybook smoke, play and a11y tests
        run: |
          npm run unittest:ci -w packages/storybook

  storycap:
    needs: storybook-static
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    steps:
      - name: â¤µï¸ Checkout
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: â™»ï¸ Restore cached node_modules and storybook-static
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/storybook/storybook-static
          key: ${{ runner.os }}-${{ hashFiles('packages/storybook/storybook-static/**') }}

      - name: ğŸ§¢ Storycap
        run: |
          npm run storycap:ci -w packages/storybook

      - name: ğŸ” Manually check results
        run: |
          git status
