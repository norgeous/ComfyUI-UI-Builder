name: ğŸ¦¾ CI
on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string
    outputs:
      KEY_BRANCH:
        description: 'The first output string'
        value: ${{ jobs.cache-keys.outputs.KEY_BRANCH }}
      KEY_MODULES:
        description: 'The second output string'
        value: ${{ jobs.cache-keys.outputs.KEY_MODULES }}

jobs:
  cache-keys:
    name: ğŸ”‘ Invent cache keys
    runs-on: ubuntu-latest
    outputs:
      KEY_BRANCH: ${{ steps.cache_keys.outputs.KEY_BRANCH }}
      KEY_MODULES: ${{ steps.cache_keys.outputs.KEY_MODULES }}
    steps:
      - name: â¤µï¸ Checkout "${{ inputs.ref }}" branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: ğŸ”‘ Invent keys for this run
        id: cache_keys
        run: |
          echo "KEY_BRANCH=${{hashFiles('**/src', '**/public')}}" | tee -a $GITHUB_OUTPUT | tee -a $GITHUB_STEP_SUMMARY
          echo "KEY_MODULES=node_modules-${{hashFiles('**/package.json', '**/package-lock.json')}}" | tee -a $GITHUB_OUTPUT | tee -a $GITHUB_STEP_SUMMARY

  npm-install:
    name: ğŸ§° NPM Install
    needs: [cache-keys]
    runs-on: ubuntu-latest
    steps:
      - name: â™»ï¸ Restore node_modules
        id: node_modules_cache
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/storybook/node_modules
          key: ${{ needs.cache-keys.outputs.KEY_MODULES }}

      - name: â¤µï¸ Checkout "develop" branch
        if: steps.node_modules_cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: ğŸ§° NPM Install
        if: steps.node_modules_cache.outputs.cache-hit != 'true'
        run: |
          npm ci

  lint:
    needs: [cache-keys, npm-install]
    runs-on: ubuntu-latest
    steps:
      - name: â¤µï¸ Checkout "develop" branch
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: â™»ï¸ Restore node_modules
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/storybook/node_modules
          key: ${{ needs.cache-keys.outputs.KEY_MODULES }}

      - name: ğŸ§µ Lint
        run: |
          npm run lint | tee $GITHUB_STEP_SUMMARY

  vite-build:
    needs: [cache-keys, npm-install]
    runs-on: ubuntu-latest
    steps:
      - name: â™»ï¸ Restore dist
        id: dist_cache
        uses: actions/cache@v4
        with:
          path: dist
          key: dist-${{ needs.cache-keys.outputs.KEY_BRANCH }}

      - name: â¤µï¸ Checkout "develop" branch
        if: steps.dist_cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: â™»ï¸ Restore node_modules
        if: steps.dist_cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/storybook/node_modules
          key: ${{ needs.cache-keys.outputs.KEY_MODULES }}

      - name: ğŸ‡» Vite Build
        if: steps.dist_cache.outputs.cache-hit != 'true'
        run: |
          npm run build

  storybook-static:
    needs: [cache-keys, npm-install]
    runs-on: ubuntu-latest
    steps:
      - name: â™»ï¸ Restore storybook-static
        id: storybook_static_cache
        uses: actions/cache@v4
        with:
          path: packages/storybook/storybook-static
          key: storybook-static-${{ needs.cache-keys.outputs.KEY_BRANCH }}

      - name: â¤µï¸ Checkout "develop" branch
        if: steps.storybook_static_cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: â™»ï¸ Restore node_modules
        if: steps.storybook_static_cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/storybook/node_modules
          key: ${{ needs.cache-keys.outputs.KEY_MODULES }}

      - name: ğŸ“• Build storybook-static
        if: steps.storybook_static_cache.outputs.cache-hit != 'true'
        run: |
          npm run sb:build

  storybook-test:
    needs: [cache-keys, storybook-static]
    runs-on: ubuntu-latest
    steps:
      - name: â™»ï¸ Restore storybook-test-report
        id: storybook_test_report_cache
        uses: actions/cache@v4
        with:
          path: storybook-test-report.txt
          key: storybook-test-report-${{ needs.cache-keys.outputs.KEY_BRANCH }}

      - name: â¤µï¸ Checkout "develop" branch
        if: steps.storybook_test_report_cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: â™»ï¸ Restore node_modules
        if: steps.storybook_test_report_cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/storybook/node_modules
          key: ${{ needs.cache-keys.outputs.KEY_MODULES }}

      - name: â™»ï¸ Restore storybook-static
        if: steps.storybook_test_report_cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: packages/storybook/storybook-static
          key: storybook-static-${{ needs.cache-keys.outputs.KEY_BRANCH }}

      - name: â–¶ï¸ Playwright Install
        if: steps.storybook_test_report_cache.outputs.cache-hit != 'true'
        run: |
          npx playwright install chromium

      - name: ğŸ§ª Storybook smoke, play and a11y tests
        if: steps.storybook_test_report_cache.outputs.cache-hit != 'true'
        run: |
          npm run unittest:ci -w packages/storybook | tee -a TESTRESULT.txt
          EXITCODE=$?
          cat TESTRESULT.txt | grep "\[TEST\]" > storybook-test-report.txt
          cat storybook-test-report.txt > $GITHUB_STEP_SUMMARY
          exit $EXITCODE

  storycap:
    needs: [cache-keys, storybook-static]
    runs-on: ubuntu-latest
    steps:
      - name: â™»ï¸ Restore storycaps
        id: storycaps_cache
        uses: actions/cache@v4
        with:
          path: _storycaps_
          key: storycaps-${{ needs.cache-keys.outputs.KEY_BRANCH }}

      - name: â¤µï¸ Checkout "develop" branch
        if: steps.storycaps_cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: â™»ï¸ Restore node_modules
        if: steps.storycaps_cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/storybook/node_modules
          key: ${{ needs.cache-keys.outputs.KEY_MODULES }}

      - name: â™»ï¸ Restore storybook-static
        if: steps.storycaps_cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: packages/storybook/storybook-static
          key: storybook-static-${{ needs.cache-keys.outputs.KEY_BRANCH }}

      - name: ğŸ‘º Puppeteer Install
        if: steps.storycaps_cache.outputs.cache-hit != 'true'
        run: |
          npx puppeteer browsers install chrome

      - name: ğŸ§¢ Storycap
        if: steps.storycaps_cache.outputs.cache-hit != 'true'
        run: |
          rm -rf _storycaps_
          npm run storycap:ci -w packages/storybook

      - name: ğŸ‘¤ Setup git user
        if: steps.storycaps_cache.outputs.cache-hit != 'true'
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

      - name: âœï¸ Commit to orphan "storycaps" branch
        if: steps.storycaps_cache.outputs.cache-hit != 'true'
        run: |
          git checkout --orphan storycaps
          git rm --cached -rf .
          git add _storycaps_
          find _storycaps_ -type f -printf '![storycap](https://raw.githubusercontent.com/norgeous/ComfyUI-UI-Builder/storycaps/%p)\n' | sort | sed 's/ /%20/g' > README.md
          git add README.md
          git commit -m "ğŸ§¢ Storycaps"

      - name: ğŸ«¸ Force push "storycaps" branch to origin
        if: steps.storycaps_cache.outputs.cache-hit != 'true'
        run: |
          git push origin storycaps --force

  visdiff-report:
    needs: [cache-keys, storycap]
    runs-on: ubuntu-latest
    steps:
      - name: â™»ï¸ Restore visdiff-report
        id: visdiff_report_cache
        uses: actions/cache@v4
        with:
          path: packages/storybook/visdiff-report
          key: visdiff-report-${{ needs.cache-keys.outputs.KEY_BRANCH }}

      - name: â¤µï¸ Checkout "develop" branch
        if: steps.visdiff_report_cache.outputs.cache-hit != 'true'
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: â™»ï¸ Restore node_modules
        if: steps.visdiff_report_cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            packages/storybook/node_modules
          key: ${{ needs.cache-keys.outputs.KEY_MODULES }}

      - name: âš¾ Move baseline into report directory
        if: steps.visdiff_report_cache.outputs.cache-hit != 'true'
        run: |
          mkdir packages/storybook/visdiff-report/
          mv _storycaps_ packages/storybook/visdiff-report/expected/

      - name: â™»ï¸ Restore storycaps
        if: steps.visdiff_report_cache.outputs.cache-hit != 'true'
        uses: actions/cache@v4
        with:
          path: _storycaps_
          key: storycaps-${{ needs.cache-keys.outputs.KEY_BRANCH }}

      - name: ğŸ­ Generate visdiff-report
        if: steps.visdiff_report_cache.outputs.cache-hit != 'true'
        id: generate
        run: |
          SUMMARY=`npm run regression -w packages/storybook | grep items | sed -r "s/\x1B\[([0-9]{1,3}(;[0-9]{1,2};?)?)?[mGK]//g" | sed "s/\[reg-suit\] info    //g"`
          CHANGED=`echo "$SUMMARY" | grep "Changed items: " | sed "s/Changed items: //"`
          NEW=`echo "$SUMMARY" | grep "New items: " | sed "s/New items: //"`
          DELETED=`echo "$SUMMARY" | grep "Deleted items: " | sed "s/Deleted items: //"`
          PASSED=`echo "$SUMMARY" | grep "Passed items: " | sed "s/Passed items: //"`
          echo "ğŸ­ Changed items: $CHANGED" | tee -a $GITHUB_STEP_SUMMARY
          echo "ğŸ†• New items: $NEW" | tee -a $GITHUB_STEP_SUMMARY
          echo "ğŸ—‘ï¸ Deleted items: $DELETED" | tee -a $GITHUB_STEP_SUMMARY
          echo "âœ… Passed items: $PASSED" | tee -a $GITHUB_STEP_SUMMARY
          EXITCODE=$((CHANGED + NEW + DELETED))
          echo | tee -a $GITHUB_STEP_SUMMARY
          echo "EXITCODE=$EXITCODE" | tee -a $GITHUB_OUTPUT | tee -a $GITHUB_STEP_SUMMARY
          ((EXITCODE > 0)) && echo -e "Fail âŒ" || echo -e "Pass âœ…" | tee -a $GITHUB_STEP_SUMMARY
          exit 0

      - name: ğŸ’¾ Save visdiff-report
        if: steps.visdiff_report_cache.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: packages/storybook/visdiff-report
          key: visdiff-report-${{ needs.cache-keys.outputs.KEY_BRANCH }}

      - name: ğŸ‘‹ Exit code
        if: steps.visdiff_report_cache.outputs.cache-hit != 'true'
        run: |
          echo "Exit code: ${{ steps.generate.outputs.EXITCODE }}"
          exit ${{ steps.generate.outputs.EXITCODE }}
