name: ü¶æ CI
on:
  push:
    branches:
      - develop

    # Trigger the action only when files change in the folders defined here
    paths:
      [
        '.github/workflows/ci.yml',
        'packages/storybook/**',
        'public/**',
        'src/components/**',
        'README.release.md',
        '**/*.stories.*',
      ]

jobs:
  npm-install:
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Checkout "develop" branch
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: üß∞ NPM Install
        run: |
          npm ci

      - name: üíæ Cache node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node_modules

  lint:
    needs: [npm-install]
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Checkout "develop" branch
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: ‚ôªÔ∏è Restore node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node_modules

      - name: üßµ Lint
        run: |
          npm run lint >> $GITHUB_STEP_SUMMARY

  vite-build:
    needs: [npm-install]
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Checkout "develop" branch
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: ‚ôªÔ∏è Restore node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node_modules

      - name: üáª Vite Build
        run: |
          npm run build

      - name: üíæ Cache dist
        uses: actions/cache@v4
        with:
          path: dist
          key: dist

  release:
    needs: [lint, vite-build, storybook-test, visdiff-report]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: ‚§µÔ∏è Checkout "develop" branch
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: ‚ôªÔ∏è Restore dist
        uses: actions/cache@v4
        with:
          path: dist
          key: dist

      - name: üìã Prepare orphan "release" branch
        run: |
          git checkout --orphan release
          git rm -rf .github/workflows .vscode public packages src _storycaps_
          git rm -f .eslintrc.cjs .gitattributes .gitignore README.md TODO.md index.html jsconfig.json package-lock.json package.json prettier.config.js vite.config.js
          cp README.release.md README.md
          git rm -f README.release.md
          echo -e 'node_modules\n__pycache__\n' > .gitignore

      - name: üë§ Setup git user
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

      - name: ‚úçÔ∏è Commit to "release" branch
        run: |
          git add dist/
          git add README.md
          git add .gitignore
          git commit -m "üáª Vite Build"

      - name: ü´∏ Force push "release" branch to origin
        run: |
          git push origin release --force

  storybook-static:
    needs: [npm-install]
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Checkout "develop" branch
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: ‚ôªÔ∏è Restore node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node_modules

      - name: üìï Build storybook-static
        run: |
          npm run sb:build

      - name: üíæ Cache storybook-static
        uses: actions/cache@v4
        with:
          path: packages/storybook/storybook-static
          key: storybook-static

  storybook-test:
    needs: [storybook-static]
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Checkout "develop" branch
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: ‚ôªÔ∏è Restore cached node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node_modules

      - name: ‚ôªÔ∏è Restore cached storybook-static
        uses: actions/cache@v4
        with:
          path: packages/storybook/storybook-static
          key: storybook-static

      - name: ‚ñ∂Ô∏è Playwright Install
        run: |
          npx playwright install chromium

      - name: üß™ Storybook smoke, play and a11y tests
        run: |
          npm run unittest:ci -w packages/storybook >> $GITHUB_STEP_SUMMARY

  storycap:
    needs: [storybook-static]
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Checkout "develop" branch
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: ‚ôªÔ∏è Restore cached node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node_modules

      - name: ‚ôªÔ∏è Restore cached storybook-static
        uses: actions/cache@v4
        with:
          path: packages/storybook/storybook-static
          key: storybook-static

      - name: üë∫ Puppeteer Install
        run: |
          npx puppeteer browsers install chrome

      - name: üß¢ Storycap
        run: |
          rm -rf _storycaps_
          npm run storycap:ci -w packages/storybook

      - name: üíæ Cache storycaps
        uses: actions/cache@v4
        with:
          path: _storycaps_
          key: storycaps

      - name: üë§ Setup git user
        run: |
          git config user.name github-actions
          git config user.email github-actions@github.com

      - name: ‚úçÔ∏è Commit to orphan "storycaps" branch
        run: |
          git checkout --orphan storycaps
          git rm --cached -rf .
          git add _storycaps_
          find _storycaps_ -type f -printf '![storycap](https://raw.githubusercontent.com/norgeous/ComfyUI-UI-Builder/storycaps/%p)\n' | sed 's/ /%20/g' > README.md
          git add README.md
          git commit -m "üß¢ Storycaps"

      - name: ü´∏ Force push "storycaps" branch to origin
        run: |
          git push origin storycaps --force

  visdiff-report:
    needs: [storycap]
    runs-on: ubuntu-latest
    steps:
      - name: ‚§µÔ∏è Checkout "develop" branch
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: ‚ôªÔ∏è Restore node_modules
        uses: actions/cache@v4
        with:
          path: node_modules
          key: node_modules

      - name: ‚öæ Move baseline into report directory
        run: |
          mkdir packages/storybook/visdiff-report/
          mv _storycaps_ packages/storybook/visdiff-report/expected/

      - name: ‚ôªÔ∏è Restore storycaps
        uses: actions/cache@v4
        with:
          path: _storycaps_
          key: storycaps

      - name: üé≠ Generate visdiff-report
        run: |
          echo "new baseline:"
          ls -l _storycaps_/
          echo "expected:"
          ls -l packages/storybook/visdiff-report/expected/
          echo "TERM: $TERM"
          export TERM=xterm-mono
          echo "TERM: $TERM"
          echo "making the report now..."
          npm run regression -w packages/storybook >> $GITHUB_STEP_SUMMARY
          echo "exit code: $?"
          echo "$GITHUB_STEP_SUMMARY"

      - name: üÜô Upload artifact
        uses: actions/upload-artifact@v4
        with:
          path: packages/storybook/visdiff-report
          name: visdiff-report

  github-pages-deploy:
    needs: [lint, storybook-static, storybook-test, visdiff-report]
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    steps:
      - name: ‚ôªÔ∏è Restore cached storybook-static
        uses: actions/cache@v4
        with:
          path: packages/storybook/storybook-static
          key: storybook-static

      - name: üÜô Upload artifact
        uses: actions/upload-pages-artifact@v3.0.1
        with:
          path: packages/storybook/storybook-static
          name: storybook-static

      - name: üöÄ Deploy artifact to Github pages
        uses: actions/deploy-pages@v4
        with:
          artifact_name: storybook-static
